{"version":3,"sources":["assets\\Script\\RenderAlternative.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import { RenderReactiveHandler } from \"./RenderReactiveHandler\";\r\n\r\n/**\r\n * 目前该渲染代理功能存在的问题\r\n * 1.被代理节点的父级不能出现scaleX和scaleY不一致的情况，被代理节点本身没有这个限制\r\n */\r\nconst { ccclass, property } = cc._decorator;\r\n@ccclass\r\nexport default class RenderAlternative extends cc.Component {\r\n    /**渲染层节点 */\r\n    public renderLayer: cc.Node = null;\r\n    /**渲染的zIndex 动态调整zIndex,用于方便临近合批 */\r\n    @property\r\n    public renderZIndex: number = 0;\r\n    /**同步的间隔（帧为单位） */\r\n    @property({\r\n        tooltip: '设置同步的间隔(秒为单位)，0就是每帧都同步，0.1就是隔0.1秒同步一次'\r\n    })\r\n    public syncInv: number = 0.01;\r\n    /**渲染的sIndex */\r\n    public sIndex: number = 0;\r\n    /**非渲染组件 */\r\n    public proxyRender: cc.RenderComponent = null;\r\n    /**渲染组件 */\r\n    private renderCompnent: cc.RenderComponent = null;\r\n    /**上次更新的数据 */\r\n    public lastWMat4: cc.Mat4 = null;\r\n    /**上次更新的数据 */\r\n    public lastLMat4: cc.Mat4 = null;\r\n    /**上次更新的数据 */\r\n    public lastPos: cc.Vec3 = null;\r\n    /**距离下次刷新累计了多少间隔 */\r\n    public accuTime: number = 0;\r\n    /**最后一次刷新时间 */\r\n    public lastFrameTime: number = null;\r\n    /**是否进行刷新 */\r\n    public isAttachFrame: boolean = false;\r\n\r\n    /**获取总的ZIndex */\r\n    get zIndex() {\r\n        let zIndex = this.renderZIndex + (this.sIndex * 0.01);\r\n        let parentNode = this.node.parent;\r\n        while (parentNode != this.renderLayer.parent && parentNode != cc.director.getScene()) {\r\n            let render = parentNode.getComponent(RenderAlternative);\r\n            if (render) {\r\n                zIndex += render.zIndex + 1;\r\n                break;\r\n            }\r\n            parentNode = parentNode.parent;\r\n        }\r\n        return zIndex;\r\n    }\r\n\r\n    /**\r\n     * 设置渲染节点层\r\n     * @param layer \r\n     */\r\n    init<T extends cc.RenderComponent>(layer?: cc.Node): T {\r\n        if (layer) {\r\n            this.renderLayer = layer;\r\n        }\r\n        if (!this.renderLayer) {\r\n            console.warn(`节点${this.node.name}没有设置渲染层`)\r\n            return null;\r\n        }\r\n        return this.initRender<T>();\r\n    }\r\n    /**\r\n     * 初始化渲染节点\r\n     */\r\n    private initRender<T extends cc.RenderComponent>(): T {\r\n        let node = this.getRender();\r\n        node.setParent(this.renderLayer ? this.renderLayer : cc.director.getScene().getChildByName(\"Canvas\"));\r\n        this.isAttachFrame = true;\r\n        requestAnimationFrame(this.frameUpdate.bind(this));\r\n        return this.doProxy<T>();\r\n    }\r\n    /**生成代理 */\r\n    private doProxy<T extends cc.RenderComponent>(): T {\r\n        this.proxyRender = new Proxy(this.renderCompnent, new RenderReactiveHandler()) as T;\r\n        return this.proxyRender as T;\r\n    }\r\n\r\n\r\n    protected frameUpdate(): void {\r\n        let now = cc.sys.now();\r\n        !this.lastFrameTime && (this.lastFrameTime = now);\r\n        let dt = now - this.lastFrameTime;\r\n        if (this.proxyRender) {\r\n            this.accuTime += dt;\r\n            if (this.accuTime >= this.syncInv) {\r\n                this.accuTime -= this.syncInv;\r\n                this.updateProp();\r\n            }\r\n        }\r\n        if (this.isAttachFrame) {\r\n            requestAnimationFrame(this.frameUpdate.bind(this));\r\n        }\r\n    }\r\n\r\n    /**更新最新状态 */\r\n    public updateProp() {\r\n        let node = this.renderCompnent.node;\r\n        if (!this.node.activeInHierarchy) {\r\n            node.opacity = 0;\r\n            return;\r\n        }\r\n        node.anchorX = this.node.anchorX;\r\n        node.anchorY = this.node.anchorY;\r\n        node.width = this.node.width;\r\n        node.height = this.node.height;\r\n        node.group = this.node.group;\r\n        node.color = this.node.color;\r\n        node.opacity = this.getOpacity(this.node);\r\n\r\n        let wMat4 = cc.mat4();\r\n        this.node.getWorldMatrix(wMat4);\r\n        if (!this.lastWMat4 || !this.lastWMat4.equals(wMat4)) {\r\n            let localMatrix = this.getLocalMatrix(wMat4, node);\r\n            this.setLocalXYZScaleAngle(localMatrix, node, this.lastLMat4);\r\n            this.lastWMat4 = wMat4;\r\n            this.lastLMat4 = localMatrix;\r\n        }\r\n        node.zIndex = this.zIndex;\r\n    }\r\n\r\n    private getLocalMatrix(worldMatrix: cc.Mat4, node: cc.Node) {\r\n        let parentNode = null;\r\n        if (cc.isValid(node)) {\r\n            if (cc.isValid(node.parent)) {\r\n                parentNode = node.parent\r\n            }\r\n        }\r\n        // 获取父节点的世界矩阵\r\n        let parentWorldMatrix = cc.mat4();\r\n        parentNode.getWorldMatrix(parentWorldMatrix);\r\n        // 获取父节点的逆矩阵\r\n        let parentInverseMatrix = parentWorldMatrix.invert();\r\n        // 将目标节点的世界矩阵转换为父节点的本地矩阵\r\n        let localMatrix = parentInverseMatrix.multiply(worldMatrix);\r\n        return localMatrix;\r\n\r\n    }\r\n\r\n    private setLocalXYZScaleAngle(matrix: cc.Mat4, node: cc.Node, lastMatrix?: cc.Mat4) {\r\n        if (lastMatrix && matrix.equals(lastMatrix)) {\r\n            return;\r\n        }\r\n\r\n        // 提取位置\r\n        node.setPosition(matrix.m[12], matrix.m[13], matrix.m[14]);\r\n\r\n        let scaleX = null;\r\n        let scaleY = null;\r\n        let angle = null;\r\n        // 提取缩放X\r\n        if (!lastMatrix) {\r\n            scaleX = Math.sqrt(matrix.m[0] * matrix.m[0] + matrix.m[1] * matrix.m[1] + matrix.m[2] * matrix.m[2]);\r\n        } else if (!this.equalsValue(matrix.m[0], lastMatrix.m[0])\r\n            || !this.equalsValue(matrix.m[1], lastMatrix.m[1])\r\n            || !this.equalsValue(matrix.m[2], lastMatrix.m[2])) {\r\n            scaleX = Math.sqrt(matrix.m[0] * matrix.m[0] + matrix.m[1] * matrix.m[1] + matrix.m[2] * matrix.m[2]);\r\n        }\r\n        // 提取缩放Y\r\n        if (!lastMatrix) {\r\n            scaleY = Math.sqrt(matrix.m[4] * matrix.m[4] + matrix.m[5] * matrix.m[5] + matrix.m[6] * matrix.m[6]);\r\n        } else if (!this.equalsValue(matrix.m[4], lastMatrix.m[4])\r\n            || !this.equalsValue(matrix.m[5], lastMatrix.m[5])\r\n            || !this.equalsValue(matrix.m[6], lastMatrix.m[6])) {\r\n            scaleY = Math.sqrt(matrix.m[4] * matrix.m[4] + matrix.m[5] * matrix.m[5] + matrix.m[6] * matrix.m[6]);\r\n        }\r\n        //设置缩放X\r\n        if (scaleX !== null) {\r\n            node.scaleX = scaleX;\r\n            // 提取旋转\r\n            angle = Math.atan2(matrix.m[1] / scaleX, matrix.m[0] / scaleX) * (180 / Math.PI);\r\n        }\r\n        if (scaleY !== null) {\r\n            node.scaleY = scaleY;\r\n        }\r\n        if (angle !== null) {\r\n            node.rotation = angle;\r\n        }\r\n    }\r\n\r\n    private equalsValue(a: number, b: number, epsilon: number = 0.00001) {\r\n        return Math.abs(a - b) < epsilon;\r\n    }\r\n\r\n    protected onDestroy(): void {\r\n        this.renderCompnent.node.destroy();\r\n        this.renderCompnent = null;\r\n        this.proxyRender = null;\r\n    }\r\n\r\n    /**\r\n     * 获取节点透明度\r\n     * @param node \r\n     */\r\n    private getOpacity(node: cc.Node) {\r\n        let opacity = (node.opacity / 255);\r\n        let parentNode = node.parent\r\n        while (parentNode != this.renderLayer.parent && parentNode != cc.director.getScene()) {\r\n            opacity *= (parentNode.opacity / 255);\r\n            parentNode = parentNode.parent;\r\n        }\r\n        return opacity * 255;\r\n    }\r\n    /**\r\n     * 获取渲染组件\r\n     * @param node \r\n     */\r\n    private getRender() {\r\n        let node = cc.instantiate(this.node);\r\n        node.removeAllChildren();\r\n        this.renderCompnent = node.getComponent(cc.RenderComponent);\r\n        this.node.getComponent(cc.LabelOutline)?.destroy();\r\n        this.node.getComponent(cc.LabelShadow)?.destroy();\r\n        this.node.getComponent(cc.RenderComponent).destroy();\r\n        let components = node.getComponents(cc.Component);\r\n        for (let i = 0, len = components.length; i < len; ++i) {\r\n            let comp = components[i];\r\n            if (!((comp instanceof cc.RenderComponent) || (comp instanceof cc.LabelOutline) || (comp instanceof cc.LabelShadow))) {\r\n                comp.destroy();\r\n            }\r\n        }\r\n        return node;\r\n    }\r\n\r\n}\r\n"]}