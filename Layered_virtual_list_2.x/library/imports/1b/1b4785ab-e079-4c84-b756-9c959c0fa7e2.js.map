{"version":3,"sources":["assets\\Script\\RenderAlternative_old.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;AAAA,iEAAgE;AAEhE;;;GAGG;AACG,IAAA,KAAwB,EAAE,CAAC,UAAU,EAAnC,OAAO,aAAA,EAAE,QAAQ,cAAkB,CAAC;AAE5C;IAA+C,qCAAY;IAA3D;QAAA,qEAkNC;QAjNG,WAAW;QACJ,iBAAW,GAAY,IAAI,CAAC;QACnC,mCAAmC;QAE5B,kBAAY,GAAW,CAAC,CAAC;QAChC,iBAAiB;QAIV,aAAO,GAAW,IAAI,CAAC;QAC9B,eAAe;QACR,YAAM,GAAW,CAAC,CAAC;QAC1B,WAAW;QACJ,iBAAW,GAAuB,IAAI,CAAC;QAC9C,UAAU;QACF,oBAAc,GAAuB,IAAI,CAAC;QAClD,aAAa;QACN,eAAS,GAAY,IAAI,CAAC;QACjC,aAAa;QACN,eAAS,GAAY,IAAI,CAAC;QACjC,aAAa;QACN,aAAO,GAAY,IAAI,CAAC;QAC/B,mBAAmB;QACZ,cAAQ,GAAW,CAAC,CAAC;QAC5B,cAAc;QACP,mBAAa,GAAW,IAAI,CAAC;QACpC,YAAY;QACL,mBAAa,GAAY,KAAK,CAAC;;IAsL1C,CAAC;0BAlNoB,iBAAiB;IA+BlC,sBAAI,qCAAM;QADV,gBAAgB;aAChB;YACI,IAAI,MAAM,GAAG,IAAI,CAAC,YAAY,GAAG,CAAC,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,CAAC;YACtD,IAAI,UAAU,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC;YAClC,OAAO,UAAU,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,IAAI,UAAU,IAAI,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,EAAE;gBAClF,IAAI,MAAM,GAAG,UAAU,CAAC,YAAY,CAAC,mBAAiB,CAAC,CAAC;gBACxD,IAAI,MAAM,EAAE;oBACR,MAAM,IAAI,MAAM,CAAC,MAAM,GAAG,CAAC,CAAC;oBAC5B,MAAM;iBACT;gBACD,UAAU,GAAG,UAAU,CAAC,MAAM,CAAC;aAClC;YACD,OAAO,MAAM,CAAC;QAClB,CAAC;;;OAAA;IAED;;;OAGG;IACH,gCAAI,GAAJ,UAAmC,KAAe;QAC9C,IAAI,KAAK,EAAE;YACP,IAAI,CAAC,WAAW,GAAG,KAAK,CAAC;SAC5B;QACD,IAAI,CAAC,IAAI,CAAC,WAAW,EAAE;YACnB,OAAO,CAAC,IAAI,CAAC,iBAAK,IAAI,CAAC,IAAI,CAAC,IAAI,+CAAS,CAAC,CAAA;YAC1C,OAAO,IAAI,CAAC;SACf;QACD,OAAO,IAAI,CAAC,UAAU,EAAK,CAAC;IAChC,CAAC;IACD;;OAEG;IACK,sCAAU,GAAlB;QACI,IAAI,IAAI,GAAG,IAAI,CAAC,SAAS,EAAE,CAAC;QAC5B,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,CAAC,CAAC,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC,CAAC;QACtG,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC;QAC1B,qBAAqB,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;QACnD,OAAO,IAAI,CAAC,OAAO,EAAK,CAAC;IAC7B,CAAC;IACD,UAAU;IACF,mCAAO,GAAf;QACI,IAAI,CAAC,WAAW,GAAG,IAAI,KAAK,CAAC,IAAI,CAAC,cAAc,EAAE,IAAI,6CAAqB,EAAE,CAAM,CAAC;QACpF,OAAO,IAAI,CAAC,WAAgB,CAAC;IACjC,CAAC;IAGS,uCAAW,GAArB;QACI,IAAI,GAAG,GAAG,EAAE,CAAC,GAAG,CAAC,GAAG,EAAE,CAAC;QACvB,CAAC,IAAI,CAAC,aAAa,IAAI,CAAC,IAAI,CAAC,aAAa,GAAG,GAAG,CAAC,CAAC;QAClD,IAAI,EAAE,GAAG,GAAG,GAAG,IAAI,CAAC,aAAa,CAAC;QAClC,IAAI,IAAI,CAAC,WAAW,EAAE;YAClB,IAAI,CAAC,QAAQ,IAAI,EAAE,CAAC;YACpB,IAAI,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,OAAO,EAAE;gBAC/B,IAAI,CAAC,QAAQ,IAAI,IAAI,CAAC,OAAO,CAAC;gBAC9B,IAAI,CAAC,UAAU,EAAE,CAAC;aACrB;SACJ;QACD,IAAI,IAAI,CAAC,aAAa,EAAE;YACpB,qBAAqB,CAAC,IAAI,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC,CAAC;SACtD;IACL,CAAC;IAED,YAAY;IACL,sCAAU,GAAjB;QACI,IAAI,IAAI,GAAG,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC;QACpC,IAAI,CAAC,IAAI,CAAC,IAAI,CAAC,iBAAiB,EAAE;YAC9B,IAAI,CAAC,OAAO,GAAG,CAAC,CAAC;YACjB,OAAO;SACV;QACD,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC;QACjC,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,IAAI,CAAC,OAAO,CAAC;QACjC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC;QAC7B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC;QAC/B,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC;QAC7B,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC;QAC7B,IAAI,CAAC,OAAO,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAE1C,IAAI,KAAK,GAAG,EAAE,CAAC,IAAI,EAAE,CAAC;QACtB,IAAI,CAAC,IAAI,CAAC,cAAc,CAAC,KAAK,CAAC,CAAC;QAChC;2CACmC;QACnC,0BAA0B;QAC1B,IAAI,IAAI,CAAC,yEAAyE,EAAE;YAChF,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAC1B,IAAI,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;YAC1B,IAAI,CAAC,WAAW,EAAE,CAAC;YACnB;uCAC2B;SAC9B;QACD,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;QAC1B,IAAI,CAAC,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC;IAC9B,CAAC;IAES,qCAAS,GAAnB;QACI,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,OAAO,EAAE,CAAC;QACnC,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC;QAC3B,IAAI,CAAC,WAAW,GAAG,IAAI,CAAC;IAC5B,CAAC;IAED;;;OAGG;IACK,sCAAU,GAAlB,UAAmB,IAAa;QAC5B,IAAI,OAAO,GAAG,CAAC,IAAI,CAAC,OAAO,GAAG,GAAG,CAAC,CAAC;QACnC,IAAI,UAAU,GAAG,IAAI,CAAC,MAAM,CAAA;QAC5B,OAAO,UAAU,IAAI,IAAI,CAAC,WAAW,CAAC,MAAM,IAAI,UAAU,IAAI,EAAE,CAAC,QAAQ,CAAC,QAAQ,EAAE,EAAE;YAClF,OAAO,IAAI,CAAC,UAAU,CAAC,OAAO,GAAG,GAAG,CAAC,CAAC;YACtC,UAAU,GAAG,UAAU,CAAC,MAAM,CAAC;SAClC;QACD,OAAO,OAAO,GAAG,GAAG,CAAC;IACzB,CAAC;IACD,YAAY;IACJ,uCAAW,GAAnB;QACI,IAAI,IAAI,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,qBAAqB,CAAC,IAAI,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QACtE,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;IACpF,CAAC;IACD,YAAY;IACJ,yCAAa,GAArB,UAAsB,IAAa;QAC/B,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,KAAK,GAAG,IAAI,CAAC,4BAA4B,CAAC,IAAI,CAAC,CAAC;IAC7E,CAAC;IACD;;;;OAIG;IACK,wDAA4B,GAApC,UAAqC,MAAe;QAChD,SAAS;QACT,IAAI,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAC1G,IAAI,MAAM,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;QAE1G,yBAAyB;QACzB,IAAI,KAAK,GAAG,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,EAAE,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,MAAM,CAAC,CAAC;QAEnE,WAAW;QACX,IAAI,OAAO,GAAG,KAAK,GAAG,CAAC,GAAG,GAAG,IAAI,CAAC,EAAE,CAAC,CAAC;QACtC,OAAO,OAAO,CAAC;IACnB,CAAC;IACD;;;OAGG;IACK,yCAAa,GAArB,UAAsB,IAAa;QAC/B,IAAI,KAAK,GAAG,IAAI,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAA;QAC3C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,CAAC,CAAC;QAC1C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,CAAC,CAAC;QAC1C,IAAI,CAAC,cAAc,CAAC,IAAI,CAAC,MAAM,GAAG,KAAK,CAAC,CAAC,CAAC;IAC9C,CAAC;IACD;;;;OAIG;IACK,gDAAoB,GAA5B,UAA6B,IAAa;QACtC,IAAI,MAAM,GAAG,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;QAC1D,IAAI,MAAM,GAAG,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;QAC1D,IAAI,MAAM,GAAG,EAAE,CAAC,EAAE,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,CAAC,CAAC,EAAE,IAAI,CAAC,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,GAAG,EAAE,CAAC;QAC3D,OAAO,EAAE,CAAC,EAAE,CAAC,MAAM,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;IACzC,CAAC;IACD;;;OAGG;IACK,qCAAS,GAAjB;;QACI,IAAI,IAAI,GAAG,EAAE,CAAC,WAAW,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QACrC,IAAI,CAAC,iBAAiB,EAAE,CAAC;QACzB,IAAI,CAAC,cAAc,GAAG,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,eAAe,CAAC,CAAC;QAC5D,MAAA,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,YAAY,CAAC,0CAAE,OAAO,GAAG;QACnD,MAAA,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,WAAW,CAAC,0CAAE,OAAO,GAAG;QAClD,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,EAAE,CAAC,eAAe,CAAC,CAAC,OAAO,EAAE,CAAC;QACrD,IAAI,UAAU,GAAG,IAAI,CAAC,aAAa,CAAC,EAAE,CAAC,SAAS,CAAC,CAAC;QAClD,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,GAAG,GAAG,UAAU,CAAC,MAAM,EAAE,CAAC,GAAG,GAAG,EAAE,EAAE,CAAC,EAAE;YACnD,IAAI,IAAI,GAAG,UAAU,CAAC,CAAC,CAAC,CAAC;YACzB,IAAI,CAAC,CAAC,CAAC,IAAI,YAAY,EAAE,CAAC,eAAe,CAAC,IAAI,CAAC,IAAI,YAAY,EAAE,CAAC,YAAY,CAAC,IAAI,CAAC,IAAI,YAAY,EAAE,CAAC,WAAW,CAAC,CAAC,EAAE;gBAClH,IAAI,CAAC,OAAO,EAAE,CAAC;aAClB;SACJ;QACD,OAAO,IAAI,CAAC;IAChB,CAAC;;IA3MD;QADC,QAAQ;2DACuB;IAKhC;QAHC,QAAQ,CAAC;YACN,OAAO,EAAE,uCAAuC;SACnD,CAAC;sDAC4B;IAVb,iBAAiB;QADrC,OAAO;OACa,iBAAiB,CAkNrC;IAAD,wBAAC;CAlND,AAkNC,CAlN8C,EAAE,CAAC,SAAS,GAkN1D;kBAlNoB,iBAAiB","file":"","sourceRoot":"/","sourcesContent":["import { RenderReactiveHandler } from \"./RenderReactiveHandler\";\r\n\r\n/**\r\n * 目前该渲染代理功能存在的问题\r\n * 1.被代理节点的父级不能出现scaleX和scaleY不一致的情况，被代理节点本身没有这个限制\r\n */\r\nconst { ccclass, property } = cc._decorator;\r\n@ccclass\r\nexport default class RenderAlternative extends cc.Component {\r\n    /**渲染层节点 */\r\n    public renderLayer: cc.Node = null;\r\n    /**渲染的zIndex 动态调整zIndex,用于方便临近合批 */\r\n    @property\r\n    public renderZIndex: number = 0;\r\n    /**同步的间隔（帧为单位） */\r\n    @property({\r\n        tooltip: '设置同步的间隔(秒为单位)，0就是每帧都同步，0.1就是隔0.1秒同步一次'\r\n    })\r\n    public syncInv: number = 0.01;\r\n    /**渲染的sIndex */\r\n    public sIndex: number = 0;\r\n    /**非渲染组件 */\r\n    public proxyRender: cc.RenderComponent = null;\r\n    /**渲染组件 */\r\n    private renderCompnent: cc.RenderComponent = null;\r\n    /**上次更新的数据 */\r\n    public lastWMat4: cc.Mat4 = null;\r\n    /**上次更新的数据 */\r\n    public lastLMat4: cc.Mat4 = null;\r\n    /**上次更新的数据 */\r\n    public lastPos: cc.Vec3 = null;\r\n    /**距离下次刷新累计了多少间隔 */\r\n    public accuTime: number = 0;\r\n    /**最后一次刷新时间 */\r\n    public lastFrameTime: number = null;\r\n    /**是否进行刷新 */\r\n    public isAttachFrame: boolean = false;\r\n\r\n    /**获取总的ZIndex */\r\n    get zIndex() {\r\n        let zIndex = this.renderZIndex + (this.sIndex * 0.01);\r\n        let parentNode = this.node.parent;\r\n        while (parentNode != this.renderLayer.parent && parentNode != cc.director.getScene()) {\r\n            let render = parentNode.getComponent(RenderAlternative);\r\n            if (render) {\r\n                zIndex += render.zIndex + 1;\r\n                break;\r\n            }\r\n            parentNode = parentNode.parent;\r\n        }\r\n        return zIndex;\r\n    }\r\n\r\n    /**\r\n     * 设置渲染节点层\r\n     * @param layer \r\n     */\r\n    init<T extends cc.RenderComponent>(layer?: cc.Node): T {\r\n        if (layer) {\r\n            this.renderLayer = layer;\r\n        }\r\n        if (!this.renderLayer) {\r\n            console.warn(`节点${this.node.name}没有设置渲染层`)\r\n            return null;\r\n        }\r\n        return this.initRender<T>();\r\n    }\r\n    /**\r\n     * 初始化渲染节点\r\n     */\r\n    private initRender<T extends cc.RenderComponent>(): T {\r\n        let node = this.getRender();\r\n        node.setParent(this.renderLayer ? this.renderLayer : cc.director.getScene().getChildByName(\"Canvas\"));\r\n        this.isAttachFrame = true;\r\n        requestAnimationFrame(this.frameUpdate.bind(this));\r\n        return this.doProxy<T>();\r\n    }\r\n    /**生成代理 */\r\n    private doProxy<T extends cc.RenderComponent>(): T {\r\n        this.proxyRender = new Proxy(this.renderCompnent, new RenderReactiveHandler()) as T;\r\n        return this.proxyRender as T;\r\n    }\r\n\r\n\r\n    protected frameUpdate(): void {\r\n        let now = cc.sys.now();\r\n        !this.lastFrameTime && (this.lastFrameTime = now);\r\n        let dt = now - this.lastFrameTime;\r\n        if (this.proxyRender) {\r\n            this.accuTime += dt;\r\n            if (this.accuTime >= this.syncInv) {\r\n                this.accuTime -= this.syncInv;\r\n                this.updateProp();\r\n            }\r\n        }\r\n        if (this.isAttachFrame) {\r\n            requestAnimationFrame(this.frameUpdate.bind(this));\r\n        }\r\n    }\r\n\r\n    /**更新最新状态 */\r\n    public updateProp() {\r\n        let node = this.renderCompnent.node;\r\n        if (!this.node.activeInHierarchy) {\r\n            node.opacity = 0;\r\n            return;\r\n        }\r\n        node.anchorX = this.node.anchorX;\r\n        node.anchorY = this.node.anchorY;\r\n        node.width = this.node.width;\r\n        node.height = this.node.height;\r\n        node.group = this.node.group;\r\n        node.color = this.node.color;\r\n        node.opacity = this.getOpacity(this.node);\r\n\r\n        let wMat4 = cc.mat4();\r\n        this.node.getWorldMatrix(wMat4);\r\n        /* let lMat4 = cc.mat4();\r\n        this.node.getLocalMatrix(wMat4); */\r\n        //此处本可以过滤许多不必要的更新，但尚未排查出问题\r\n        if (true /* || !this.lastWMat4?.equals(wMat4) || !this.lastLMat4?.equals(lMat4) */) {\r\n            this.onAngleChange(wMat4);\r\n            this.onScaleChange(wMat4);\r\n            this.onPosChange();\r\n            /*  this.lastLMat4 = lMat4;\r\n             this.lastWMat4 = wMat4; */\r\n        }\r\n        node.zIndex = this.zIndex;\r\n        node.zIndex = this.zIndex;\r\n    }\r\n\r\n    protected onDestroy(): void {\r\n        this.renderCompnent.node.destroy();\r\n        this.renderCompnent = null;\r\n        this.proxyRender = null;\r\n    }\r\n\r\n    /**\r\n     * 获取节点透明度\r\n     * @param node \r\n     */\r\n    private getOpacity(node: cc.Node) {\r\n        let opacity = (node.opacity / 255);\r\n        let parentNode = node.parent\r\n        while (parentNode != this.renderLayer.parent && parentNode != cc.director.getScene()) {\r\n            opacity *= (parentNode.opacity / 255);\r\n            parentNode = parentNode.parent;\r\n        }\r\n        return opacity * 255;\r\n    }\r\n    /**位置变化处理 */\r\n    private onPosChange() {\r\n        let wpos = this.node.parent.convertToWorldSpaceAR(this.node.position);\r\n        this.renderCompnent.node.position = this.renderLayer.convertToNodeSpaceAR(wpos);\r\n    }\r\n    /**旋转变化处理 */\r\n    private onAngleChange(mat4: cc.Mat4) {\r\n        this.renderCompnent.node.angle = this.extractRotationAngleFromMat4(mat4);\r\n    }\r\n    /**\r\n     * 从 cc.Mat4 中获取旋转角度（不受缩放影响）\r\n     * @param matrix 输入的 cc.Mat4 矩阵\r\n     * @returns 旋转角度（以度为单位）\r\n     */\r\n    private extractRotationAngleFromMat4(matrix: cc.Mat4): number {\r\n        // 提取旋转部分\r\n        let scaleX = Math.sqrt(matrix.m[0] * matrix.m[0] + matrix.m[4] * matrix.m[4] + matrix.m[8] * matrix.m[8]);\r\n        let scaleY = Math.sqrt(matrix.m[1] * matrix.m[1] + matrix.m[5] * matrix.m[5] + matrix.m[9] * matrix.m[9]);\r\n\r\n        // 计算 Z 轴旋转角度（绕 Z 轴的旋转角度）\r\n        let angle = Math.atan2(matrix.m[1] / scaleY, matrix.m[0] / scaleX);\r\n\r\n        // 将弧度转换为角度\r\n        let degrees = angle * (180 / Math.PI);\r\n        return degrees;\r\n    }\r\n    /**\r\n     * 缩放变化处理\r\n     * @param mat4 \r\n     */\r\n    private onScaleChange(mat4: cc.Mat4) {\r\n        let scale = this.extractScaleFromMat4(mat4)\r\n        this.renderCompnent.node.scaleX = scale.x;\r\n        this.renderCompnent.node.scaleY = scale.y;\r\n        this.renderCompnent.node.scaleZ = scale.z;\r\n    }\r\n    /**\r\n     * 从mat4中获取缩放值\r\n     * @param mat4 \r\n     * @returns \r\n     */\r\n    private extractScaleFromMat4(mat4: cc.Mat4): cc.Vec3 {\r\n        let scaleX = cc.v3(mat4.m[0], mat4.m[1], mat4.m[2]).mag();\r\n        let scaleY = cc.v3(mat4.m[4], mat4.m[5], mat4.m[6]).mag();\r\n        let scaleZ = cc.v3(mat4.m[8], mat4.m[9], mat4.m[10]).mag();\r\n        return cc.v3(scaleX, scaleY, scaleZ);\r\n    }\r\n    /**\r\n     * 获取渲染组件\r\n     * @param node \r\n     */\r\n    private getRender() {\r\n        let node = cc.instantiate(this.node);\r\n        node.removeAllChildren();\r\n        this.renderCompnent = node.getComponent(cc.RenderComponent);\r\n        this.node.getComponent(cc.LabelOutline)?.destroy();\r\n        this.node.getComponent(cc.LabelShadow)?.destroy();\r\n        this.node.getComponent(cc.RenderComponent).destroy();\r\n        let components = node.getComponents(cc.Component);\r\n        for (let i = 0, len = components.length; i < len; ++i) {\r\n            let comp = components[i];\r\n            if (!((comp instanceof cc.RenderComponent) || (comp instanceof cc.LabelOutline) || (comp instanceof cc.LabelShadow))) {\r\n                comp.destroy();\r\n            }\r\n        }\r\n        return node;\r\n    }\r\n\r\n}\r\n"]}